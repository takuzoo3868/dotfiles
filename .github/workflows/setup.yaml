name: Setup

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  linux:
    name: Test deploy & init on ${{ matrix.os }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu
            container: ubuntu:22.04
            pkg_install: |
              apt-get update
              DEBIAN_FRONTEND=noninteractive apt-get install -y \
                git make ca-certificates sudo

          - os: debian
            container: debian:13
            pkg_install: |
              apt-get update
              DEBIAN_FRONTEND=noninteractive apt-get install -y \
                git make ca-certificates sudo

          - os: archlinux
            container: archlinux:latest
            pkg_install: |
              pacman -Syu --noconfirm --needed \
                git make which ca-certificates sudo

    container: 
      image: ${{ matrix.container }}

    steps:
      - name: Install required packages
        run: |
          set -eux
          ${{ matrix.pkg_install }}

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy dotfile symlinks
        env:
          TERM: xterm-256color
          DOTPATH: ${{ github.workspace }}
        run: |
          set -eux
          make deploy

      - name: Post deploy sanity check
        shell: bash
        run: |
          set -eux
          MANIFEST="$HOME/.dotfiles.manifest"
          test -f "$MANIFEST"
          while IFS= read -r line || [[ -n "$line" ]]; do
            dst=${line%% ->*}
            test -L "$dst"
          done <"$MANIFEST"

      - name: Install develop packages
        env:
          DOTPATH: ${{ github.workspace }}
          TERM: xterm-256color
        run: |
          set -eux
          make init

  darwin:
    name: Test deploy & init on macOS
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Homebrew packages
        run: |
          set -eux
          brew update
          brew install git make

      - name: Deploy dotfile symlinks
        env:
          DOTPATH: ${{ github.workspace }}
          TERM: xterm-256color
        run: |
          set -eux
          make deploy

      - name: Post deploy sanity check
        shell: bash
        run: |
          set -eux
          MANIFEST="$HOME/.dotfiles.manifest"
          test -f "$MANIFEST"
          while IFS= read -r line || [[ -n "$line" ]]; do
            dst=${line%% ->*}
            test -L "$dst"
          done <"$MANIFEST"

      - name: Install develop packages
        env:
          DOTPATH: ${{ github.workspace }}
          TERM: xterm-256color
        run: |
          set -eux
          make init