#!/usr/bin/env bash
#
# setup - dotfiles bootstrap script
#
# Author: takuzoo3868
# Last Modified: 9 Feb 2026.
#

set -Eeuo pipefail
trap 'echo "[ERROR] ${BASH_SOURCE[0]}:${LINENO} aborted." >&2' ERR INT

##############################################################################
# Globals / Defaults
###############################################################################

readonly DOTFILES_REPO="https://github.com/takuzoo3868/dotfiles.git"
readonly DOTFILES_ZIP="https://github.com/takuzoo3868/dotfiles/archive/master.zip"

: "${DOTPATH:=$HOME/.dotfiles}"
export DOTPATH

###############################################################################
# Terminal colors (safe)
###############################################################################

if command -v tput >/dev/null 2>&1 && [[ -t 1 ]] && [[ "$(tput colors 2>/dev/null || echo 0)" -ge 8 ]]; then
  RED="$(tput setaf 1)"
  GREEN="$(tput setaf 2)"
  YELLOW="$(tput setaf 3)"
  BOLD="$(tput bold)"
  RESET="$(tput sgr0)"
else
  RED=""; GREEN=""; YELLOW=""; BOLD=""; RESET=""
fi

###############################################################################
# Logging helpers
###############################################################################

info()  { printf "%s[+] %s%s\n" "$GREEN" "$*" "$RESET"; }
warn()  { printf "%s[*] %s%s\n" "$YELLOW" "$*" "$RESET"; }
error() { printf "%s[-] %s%s\n" "$RED" "$*" "$RESET" >&2; }
die()   { error "$*"; exit 1; }

###############################################################################
# Utilities
###############################################################################

has() { command -v "$1" >/dev/null 2>&1; }

require_any() {
  for cmd in "$@"; do
    has "$cmd" && return 0
  done
  return 1
}

###############################################################################
# Banner
###############################################################################

show_banner() {
  printf "%s" "$BOLD"
  cat <<'EOF'
██████╗  ██████╗ ████████╗███████╗██╗██╗     ███████╗███████╗
██╔══██╗██╔═══██╗╚══██╔══╝██╔════╝██║██║     ██╔════╝██╔════╝
██║  ██║██║   ██║   ██║   █████╗  ██║██║     █████╗  ███████╗
██║  ██║██║   ██║   ██║   ██╔══╝  ██║██║     ██╔══╝  ╚════██║
██████╔╝╚██████╔╝   ██║   ██║     ██║███████╗███████╗███████║
╚═════╝  ╚═════╝    ╚═╝   ╚═╝     ╚═╝╚══════╝╚══════╝╚══════╝

*** WHAT THIS SCRIPT DOES ***
1. Download dotfiles repository
2. Deploy dotfiles into your HOME directory
3. Optionally initialize environment

MIT License

EOF
  printf "%s" "$RESET"
}

###############################################################################
# Confirmation
###############################################################################

confirm() {
  echo "*** ATTENTION ***"
  echo "This script may modify your shell environment."
  echo "I recommend to read first. You can even copy commands one by one."
  echo "If you use termux on Android, try this."
  echo "$ /data/data/com.termux/files/usr/bin/bash"
  echo ""
  read -r -p "$(printf "%s(U^w^) < Proceed with installation? [y/N] %s" "$YELLOW" "$RESET")" ans
  [[ "${ans:-}" =~ ^[Yy]$ ]]
}

###############################################################################
# Download dotfiles (idempotent)
###############################################################################

download_dotfiles() {
  if [[ -d "$DOTPATH/.git" ]]; then
    info "Dotfiles already installed: $DOTPATH"
    return 0
  fi

  info "Downloading dotfiles to $DOTPATH"

  if has git; then
    git clone --depth=1 "$DOTFILES_REPO" "$DOTPATH"
    info "Cloned via git"
    return 0
  fi

  require_any curl wget || die "git, curl, or wget is required"

  local tmp
  tmp="$(mktemp -d)"
  trap 'rm -rf "$tmp"' RETURN

  if has curl; then
    curl -fsSL "$DOTFILES_ZIP" | tar -xz -C "$tmp"
  else
    wget -qO- "$DOTFILES_ZIP" | tar -xz -C "$tmp"
  fi

  mv "$tmp"/dotfiles-* "$DOTPATH"
  info "Downloaded via archive"
}

###############################################################################
# Deploy dotfiles (safe + idempotent)
###############################################################################

deploy_dotfiles() {
  [[ -d "$DOTPATH" ]] || die "$DOTPATH not found"

  info "Deploying dotfiles"
  cd "$DOTPATH"

  [[ -f Makefile ]] || die "Makefile not found"

  make deploy
  info "Deploy completed"
}

###############################################################################
# Initialize (optional)
###############################################################################

initialize_dotfiles() {
  case "${1:-}" in
    init|-i|--init)
      info "Running initialization"
      cd "$DOTPATH"
      make init
      info "Initialization completed"
      ;;
    *)
      info "Initialization skipped"
      ;;
  esac
}

###############################################################################
# Main
###############################################################################

main() {
  show_banner

  confirm || {
    error "Aborted by user."
    exit 1
  }

  download_dotfiles
  deploy_dotfiles
  initialize_dotfiles "${1:-}"
}

main "$@"
