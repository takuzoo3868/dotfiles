#!/usr/bin/env bash
#
# init - Initialize development environment
#
# Author: takuzoo3868
# Last Modified: 9 Feb 2026.
#

set -Eeuo pipefail
trap 'echo "[ERROR] ${BASH_SOURCE[0]}:${LINENO} aborted." >&2' ERR INT

###############################################################################
# Globals
###############################################################################

: "${DOTPATH:=$HOME/.dotfiles}"
export DOTPATH

###############################################################################
# Load shared helpers
###############################################################################

if [[ -f "$DOTPATH/etc/lib/header.sh" ]]; then
  # shellcheck source=/dev/null
  . "$DOTPATH/etc/lib/header.sh"
else
  error() { echo "[-] $*" >&2; }
  error "Failed to load shared helpers"
  exit 1
fi

OS="$(detect_os)"
info "Detected OS: $OS"

###############################################################################
# Sudo keepalive (Linux / macOS only)
###############################################################################

start_sudo_keepalive() {
  if [[ "$OS" == "windows" ]]; then
    info "Skipping sudo keepalive on $OS"
    return 0
  fi

  if ! has sudo; then
    warn "sudo not available, skipping"
    return 0
  fi

  info "Requesting sudo privileges..."
  sudo -v

  (
    while sleep 60; do
      sudo -n true || exit
    done
  ) &
  SUDO_KEEPALIVE_PID=$!
}

stop_sudo_keepalive() {
  if [[ -n "${SUDO_KEEPALIVE_PID:-}" ]]; then
    kill "$SUDO_KEEPALIVE_PID" 2>/dev/null || true
  fi
}

trap stop_sudo_keepalive EXIT

###############################################################################
# Install scripts runner
###############################################################################
run_install_scripts() {
  local base="$DOTPATH/etc/scripts/install.d"

  if [[ ! -d "$base" ]]; then
    warn "install.d not found: $base"
    return 0
  fi

  local dirs=(
    # "$base/common"
    "$base/$OS"
  )

  mapfile -t scripts < <(find "$dir" -type f -name '[0-9][0-9]*.sh' | sort)

  for dir in "${dirs[@]}"; do
    [[ -d "$dir" ]] || continue

    info "Processing install scripts in: $(basename "$dir")"

    mapfile -t scripts < <(
      find "$dir" -type f -name '[0-9][0-9]*.sh' | sort
    )

    for script in "${scripts[@]}"; do
      info "Running $(basename "$script")"
      bash "$script"
    done
  done
}

###############################################################################
# Main
###############################################################################

info "Install development packages"
start_sudo_keepalive
run_install_scripts
info "Installed development packages!"

# TODO: Replace Android termux support
# android() {
#   PKG_ANDROID="ncurses-utils binutils coreutils file grep wget taskwarrior neovim"

#   pkg update
#   pkg install "$PKG_DEFAULT"
#   pkg install "$PKG_ANDROID"
#   termux-setup-storage
# }