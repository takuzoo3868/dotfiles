#!/usr/bin/env bash
#
# Backs up a user's home directory
#
# Author: takuzoo3868
# Last Modified: 9 Feb 2026.
#

set -Eeuo pipefail
trap 'echo "[ERROR] ${BASH_SOURCE[0]}:${LINENO} aborted." >&2' ERR INT

PROGNAME="$(basename "$0")"

usage() {
  cat <<EOF
usage: $PROGNAME [OPTION]

Back up a user's home directory

options:
  --backup USERNAME
              Backs up a user's entire home directory.
              Requires the username passed as an argument.

  --restore FILE
              Restores a user's home directory from backup.
              (Not implemented yet)

  -h, --help
              Provides usage information for the script.
EOF
  exit 0
}

if [[ $# -eq 0 ]]; then
  usage
fi

while [[ $# -gt 0 ]]; do
  case "$1" in
    --backup)
      if [[ -z "${2:-}" ]]; then
        echo "Please specify the username you would like to backup." >&2
        echo "For usage information, use: --help" >&2
        exit 1
      fi

      USERNAME="$2"
      OUTPUT_DIR="/home/$USERNAME/backups"
      OUTPUT_FILE="backup-$(date +%Y%m%d).tar.gz"

      echo "Backing up ${USERNAME}'s home directory, please wait..."

      if [[ ! -d "$OUTPUT_DIR" ]]; then
        echo "Creating backup directory $OUTPUT_DIR..."
        mkdir -p "$OUTPUT_DIR"
      fi

      echo "Compressing ${USERNAME}'s home directory contents..."

      tar -pzcf \
        "$OUTPUT_DIR/$OUTPUT_FILE" \
        "/home/$USERNAME/" \
        --exclude "/home/$USERNAME/backups"

      echo "Backup completed!"
      echo
      echo "It is recommended that you copy the compressed backup file,"
      echo "located in $OUTPUT_DIR, to an external device for safe keeping."

      shift 2
      ;;

    --restore)
      if [[ -z "${2:-}" ]]; then
        echo "Please specify the backup file you would like to restore." >&2
        echo "For usage information, use: --help" >&2
        exit 1
      fi

      echo "Sorry, this ability has not yet been implemented."
      exit 1
      ;;

    -h|--help)
      usage
      ;;

    -*)
      echo "$PROGNAME: illegal option -- '${1##*-}'" >&2
      exit 1
      ;;

    *)
      usage
      ;;
  esac
done