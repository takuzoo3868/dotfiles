#!/usr/bin/env bash
#
# Detect operating system and distribution
#

set -Eeuo pipefail
trap 'echo "[ERROR] ${BASH_SOURCE[0]}:${LINENO} aborted." >&2' ERR INT

OS="$(uname -s)"
ARCH="$(uname -m)"


#######################################
# Windows (Git Bash / MSYS / Cygwin)
#######################################
case "$OS" in
  MINGW*|MSYS*)
    echo "Windows GitBash (${OS}, ${ARCH})"
    exit 0
    ;;
  CYGWIN*)
    echo "Windows Cygwin (${OS}, ${ARCH})"
    exit 0
    ;;
esac


#######################################
# Linux
#######################################
if [[ "$OS" == "Linux" ]]; then
  if [[ -r /etc/os-release ]]; then
    # shellcheck disable=SC1091
    . /etc/os-release
    echo "Linux ${ID:-unknown} ${VERSION_ID:-unknown} (${ARCH})"
    exit 0
  fi

  echo "Linux unknown (${ARCH})"
  exit 0
fi


#######################################
# macOS
#######################################
if [[ "$OS" == "Darwin" ]]; then
  PRODUCT_NAME="$(sw_vers -productName)"
  PRODUCT_VERSION="$(sw_vers -productVersion)"
  BUILD_VERSION="$(sw_vers -buildVersion)"
  echo "Darwin ${PRODUCT_NAME} ${PRODUCT_VERSION} (${BUILD_VERSION}, ${ARCH})"
  exit 0
fi


#######################################
# BSD
#######################################
if [[ "$OS" =~ BSD$ ]]; then
  RELEASE="$(uname -r)"
  echo "${OS} ${RELEASE} (${ARCH})"
  exit 0
fi


#######################################
# Unsupported
#######################################
echo "Unsupported platform: $(uname -a)" >&2
exit 1



