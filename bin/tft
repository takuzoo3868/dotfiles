#!/usr/bin/env bash
#
# Check Nerd fonts drawing on terminal.
#
# Author: takuzoo3868
# Last Modified: 11 Dec 2018.
#

set -Eeuo pipefail
trap 'echo "[ERROR] ${BASH_SOURCE[0]}:${LINENO} aborted." >&2' ERR INT

PROGNAME="$(basename "$0")"

usage() {
  cat <<EOF
usage: $PROGNAME [OPTION]

Check Nerd fonts drawing on terminal.

optionas:
  -h, --help            show this help message and exit
  --char, --unicode     Print specific unicode codepoint(s)
  --dev                 Font Devicon
  --fa                  Font Awesome
  --fae                 Font Awesome Extension
  --iec                 IEC Power Symbols
  --linux, --fontlogos  Font Linux and other open source Glyphs
  --material, --mdi     Material Design Icon
  --oct                 Octicons
  --pl                  Powerline
  --ple                 Powerline Extra
  --pom                 Pomicon
  --seti                Seti-UI + Custom
  --weather             Weather Icons
EOF
  exit 0
}

if [[ $# -eq 0 ]]; then
  usage
fi

# Given an array of decimal numbers print all unicode codepoint.
print-decimal-unicode-range() {
  local originalSequence=("$@")
  local counter=0
  local count=0

  # colors
  local bgColorBorder=$'\033[48;5;8m'
  local bgColorCode=$'\033[48;5;246m'
  local alternateBgColorCode=$'\033[48;5;240m'
  local bgColorChar=$'\033[48;5;66m'
  local alternateBgColorChar=$'\033[48;5;60m'
  local underline=$'\033[4m'
  local reset_color=$'\033[0m'

  local currentColorCode="$bgColorCode"
  local currentColorChar="$bgColorChar"

  local allChars=""
  local allCodes=""
  local wrapAt=10

  local topLine="${bgColorBorder}╔══════╦══════╦══════╦══════╦══════╦══════╦══════╦══════╦══════╦══════╗${reset_color}"
  local bottomLine="${bgColorBorder}╚══════╩══════╩══════╩══════╩══════╩══════╩══════╩══════╩══════╩══════╝${reset_color}"
  local line="${bgColorBorder}╠══════╬══════╬══════╬══════╬══════╬══════╬══════╬══════╬══════╬══════╣${reset_color}"
  local bar="${bgColorBorder}║${reset_color}"

  local originalSequenceLength=${#originalSequence[@]}
  local leftoverSpaces=$((wrapAt - (originalSequenceLength % wrapAt)))

  if (( leftoverSpaces < wrapAt )); then
    for ((i=0; i<leftoverSpaces; i++)); do
      originalSequence+=(0)
    done
  fi

  local sequenceLength=${#originalSequence[@]}

  printf '%b\n' "$topLine"
  for decimalCode in "${originalSequence[@]}"; do
    local hexCode
    hexCode=$(printf '%x' "$decimalCode")
    local code="$hexCode"
    local char
    if (( decimalCode == 0 )); then
      char=' '
      code='    '
    else
      char=$(perl -C -e "print chr($decimalCode)")
      code=$(printf "%4s" "$hexCode")
    fi

    allCodes+="${currentColorCode} ${underline}${code}${reset_color}${currentColorCode} ${reset_color}${bar}"
    allChars+="${currentColorChar}  ${char}   ${reset_color}${bar}"

    counter=$((counter + 1))
    count=$(((count + 1) % wrapAt))

    if (( count == 0 )); then
      if [[ "$currentColorCode" == "$alternateBgColorCode" ]]; then
        currentColorCode="$bgColorCode"
        currentColorChar="$bgColorChar"
      else
        currentColorCode="$alternateBgColorCode"
        currentColorChar="$alternateBgColorChar"
      fi

      printf '%b%b\n' "$bar" "$allCodes"
      printf '%b%b\n' "$bar" "$allChars"

      if (( counter != sequenceLength )); then
        printf '%b\n' "$line"
      fi

      allCodes=""
      allChars=""
    fi
  done
  printf '%b\n' "$bottomLine"
}

print-unicode-ranges() {
  echo ''

  local arr=("$@")
  local len=${#arr[@]}
  local combinedRanges=()

  for ((j=0; j<len; j+=2)); do
    local start="${arr[j]}"
    local end="${arr[j+1]}"
    local startDecimal=$((16#$start))
    local endDecimal=$((16#$end))

    while (( startDecimal <= endDecimal )); do
      combinedRanges+=("$startDecimal")
      ((startDecimal++))
    done
  done

  print-decimal-unicode-range "${combinedRanges[@]}"
}

# Convert input (U+XXXX / 0xXXXX / XXXX / char) to decimal codepoint
unicode-to-decimal() {
  local input="$1"

  # U+XXXX
  if [[ "$input" =~ ^U\+([0-9A-Fa-f]+)$ ]]; then
    printf '%d' "$((16#${BASH_REMATCH[1]}))"
    return
  fi

  # 0xXXXX
  if [[ "$input" =~ ^0x([0-9A-Fa-f]+)$ ]]; then
    printf '%d' "$((16#${BASH_REMATCH[1]}))"
    return
  fi

  # XXXX (hex only)
  if [[ "$input" =~ ^[0-9A-Fa-f]{3,6}$ ]]; then
    printf '%d' "$((16#$input))"
    return
  fi

  # actual unicode character
  LC_CTYPE=C.UTF-8 printf '%d' "'$input"
}

print-specific-unicode() {
  local codes=()
  local arg

  for arg in "$@"; do
    codes+=("$(unicode-to-decimal "$arg")")
  done

  print-decimal-unicode-range "${codes[@]}"
}

for OPT in "$@"; do
  case "$OPT" in
    -h|--help)
      usage
      ;;
    --char|--unicode)
      shift
      if (( $# == 0 )); then
        echo "Error: --char requires at least one argument" >&2
        exit 1
      fi
      echo "Nerd Fonts - Specific Unicode"
      print-specific-unicode "$@"
      exit 0
      ;;
    --dev)
      echo "Nerd Fonts - Devicons"
      print-unicode-ranges e700 e7c5
      ;;
    --fa)
      echo "Nerd Fonts - Font Awesome"
      print-unicode-ranges f000 f2e0
      ;;
    --fae)
      echo "Nerd Fonts - Font Awesome Extension"
      print-unicode-ranges e200 e2a9
      ;;
    --iec)
      echo "Nerd Fonts - IEC Power Symbols"
      print-unicode-ranges 23fb 23fe 2b58 2b58
      ;;
    --linux|--fontlogos)
      echo "Nerd Fonts - Font Linux"
      print-unicode-ranges f300 f31c
      ;;
    --material|--mdi)
      echo "Nerd Fonts - Material Design Icons"
      print-unicode-ranges f500 fd46
      ;;
    --oct)
      echo "Nerd Fonts - Octicons"
      print-unicode-ranges 2665 2665 26A1 26A1 f400 f4a8 f67c f67c
      ;;
    --pl)
      echo "Nerd Fonts - Powerline"
      print-unicode-ranges e0a0 e0a2 e0b0 e0b3
      ;;
    --ple)
      echo "Nerd Fonts - Powerline Extra"
      print-unicode-ranges e0a3 e0a3 e0b4 e0c8 e0cc e0d2 e0d4 e0d4
      ;;
    --pom)
      echo "Nerd Fonts - Pomicons"
      print-unicode-ranges e000 e00a
      ;;
    --seti)
      echo "Nerd Fonts - Symbols original"
      print-unicode-ranges e5fa e62e
      ;;
    --weather)
      echo "Nerd Fonts - Weather Icons"
      print-unicode-ranges e300 e3eb
      ;;
    -*)
      opt="${OPT#-}"
      opt="${opt#-}"
      printf '%s: illegal option -- %s\n' "$PROGNAME" "$opt" >&2
      exit 1
      ;;
    *)
      usage
      ;;
  esac
  echo
done
