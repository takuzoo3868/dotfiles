#!/usr/bin/env bash
#
# Check Nerd fonts drawing on terminal.
# Auto-adjust column width (supports 4–6+ hex digits)
#
# Author: takuzoo3868
# Last Modified: 11 Dec 2018.
#

set -Eeuo pipefail
trap 'echo "[ERROR] ${BASH_SOURCE[0]}:${LINENO} aborted." >&2' ERR INT

PROGNAME="$(basename "$0")"

usage() {
  cat <<EOF
usage: $PROGNAME [OPTION]

Check drawing on terminal. As of Nerd fonts v3.3.0

optionas:
  -h, --help            show this help message and exit
  --char, --unicode     Print specific unicode codepoint(s)
  --codi                Codicons
  --dev                 Font Devicon
  --fa                  Font Awesome
  --fae                 Font Awesome Extension
  --iec                 IEC Power Symbols
  --linux, --fontlogos  Font Linux and other open source Glyphs
  --material, --mdi     Material Design Icon
  --oct                 Octicons
  --pl                  Powerline
  --ple                 Powerline Extra
  --pom                 Pomicon
  --seti                Seti-UI + Custom
  --weather             Weather Icons
EOF
  exit 0
}

if [[ $# -eq 0 ]]; then
  usage
fi

draw_with_perl() {
  local wrapAt=16

  perl -C -e '
    use utf8;

    my $wrap = shift @ARGV;
    my @input = @ARGV;

    my $bgBorder = "\e[48;5;8m";
    my $bgCode1  = "\e[48;5;246m";
    my $bgCode2  = "\e[48;5;240m";
    my $bgChar1  = "\e[48;5;66m";
    my $bgChar2  = "\e[48;5;60m";
    my $underline = "\e[4m";
    my $reset = "\e[0m";

    my @codes;

    if ($input[0] eq "__RANGE__") {
      shift @input;
      for (my $i=0; $i<@input; $i+=2) {
        my $start = hex($input[$i]);
        my $end   = hex($input[$i+1]);
        push @codes, ($start .. $end);
      }
    } else {
      @codes = @input;
    }

    my $maxHexLen = 4;
    for my $c (@codes) {
      my $len = length(sprintf("%x",$c));
      $maxHexLen = $len if $len > $maxHexLen;
    }

    my $cellWidth = $maxHexLen + 2;
    my $borderSegment = "═" x $cellWidth;

    sub top_line {
      print $bgBorder . "╔$borderSegment";
      for (2..$wrap) { print "╦$borderSegment"; }
      print "╗$reset\n";
    }

    sub mid_line {
      print $bgBorder . "╠$borderSegment";
      for (2..$wrap) { print "╬$borderSegment"; }
      print "╣$reset\n";
    }

    sub bottom_line {
      print $bgBorder . "╚$borderSegment";
      for (2..$wrap) { print "╩$borderSegment"; }
      print "╝$reset\n";
    }

    top_line();

    my $count = 0;
    my $colorToggle = 0;

    my $codeBg = $bgCode1;
    my $charBg = $bgChar1;

    my $allCodes = "";
    my $allChars = "";

    for my $c (@codes) {

      my $hex = sprintf("%x",$c);
      my $chr = chr($c);

      my $pad = $cellWidth - length($hex);
      my $left = int($pad/2);
      my $right = $pad - $left;
      my $codeCell = (" "x$left).$hex.(" "x$right);

      $pad = $cellWidth - 1;
      $left = int($pad/2);
      $right = $pad - $left;
      my $charCell = (" "x$left).$chr.(" "x$right);

      $allCodes .= $codeBg.$underline.$codeCell.$reset.$codeBg.$bgBorder."║".$reset;
      $allChars .= $charBg.$charCell.$reset.$charBg.$bgBorder."║".$reset;

      $count++;

      if ($count % $wrap == 0) {

        print $bgBorder."║".$reset.$allCodes."\n";
        print $bgBorder."║".$reset.$allChars."\n";

        $allCodes = "";
        $allChars = "";

        if ($count < @codes) {
          mid_line();
        }

        $colorToggle = !$colorToggle;
        if ($colorToggle) {
          $codeBg = $bgCode2;
          $charBg = $bgChar2;
        } else {
          $codeBg = $bgCode1;
          $charBg = $bgChar1;
        }
      }
    }

    if (length($allCodes) > 0) {

      my $remaining = $wrap - ($count % $wrap);
      for (1 .. $remaining) {
        my $empty = " " x $cellWidth;
        $allCodes .= $codeBg.$underline.$empty.$reset.$codeBg.$bgBorder."║".$reset;
        $allChars .= $charBg.$empty.$reset.$charBg.$bgBorder."║".$reset;
      }

      print $bgBorder."║".$reset.$allCodes."\n";
      print $bgBorder."║".$reset.$allChars."\n";
    }

    bottom_line();
  ' "$wrapAt" "$@"
}

unicode-to-decimal() {
  local input="$1"

  if [[ "$input" =~ ^U\+([0-9A-Fa-f]+)$ ]]; then
    printf '%d' "$((16#${BASH_REMATCH[1]}))"
  elif [[ "$input" =~ ^0x([0-9A-Fa-f]+)$ ]]; then
    printf '%d' "$((16#${BASH_REMATCH[1]}))"
  elif [[ "$input" =~ ^[0-9A-Fa-f]{3,6}$ ]]; then
    printf '%d' "$((16#$input))"
  else
    LC_CTYPE=C.UTF-8 printf '%d' "'$input"
  fi
}

print-specific-unicode() {
  local codes=()
  for arg in "$@"; do
    codes+=("$(unicode-to-decimal "$arg")")
  done
  draw_with_perl "${codes[@]}"
}

for OPT in "$@"; do
  case "$OPT" in
    -h|--help)
      usage
      ;;
    --char|--unicode)
      shift
      if (( $# == 0 )); then
        echo "Error: --char requires at least one argument" >&2
        exit 1
      fi
      echo "Nerd Fonts - Specific Unicode"
      print-specific-unicode "$@"
      exit 0
      ;;
    --dev)
      echo "Nerd Fonts - Devicons"
      draw_with_perl "__RANGE__" e700 e8ef
      ;;
    --fa)
      echo "Nerd Fonts - Font Awesome"
      draw_with_perl "__RANGE__" f000 f2ff
      ;;
    --fae)
      echo "Nerd Fonts - Font Awesome Extension"
      draw_with_perl "__RANGE__" e200 e2a9
      ;;
    --iec|--ps)
      echo "Nerd Fonts - Font Power Symbols"
      draw_with_perl "__RANGE__" 23fb 23fe 2b58 2b58
      ;;
    --linux|--fontlogos)
      echo "Nerd Fonts - Font Logos"
      draw_with_perl "__RANGE__" f300 f381
      ;;
    --material|--mdi)
      echo "Nerd Fonts - Material Design Icons"
      draw_with_perl "__RANGE__" f0001 f1af0
      ;;
    --oct)
      echo "Nerd Fonts - Octicons"
      draw_with_perl "__RANGE__" f400 f533 2665 2665 26A1 26A1
      ;;
    --pl)
      echo "Nerd Fonts - Powerline"
      draw_with_perl "__RANGE__" e0a0 e0a2 e0b0 e0b3
      ;;
    --ple)
      echo "Nerd Fonts - Powerline Extra"
      draw_with_perl "__RANGE__" e0a3 e0a3 e0b4 e0c8 e0ca e0ca e0cc e0d7 2630 2630
      ;;
    --pom)
      echo "Nerd Fonts - Pomicons"
      draw_with_perl "__RANGE__" e000 e00a
      ;;
    --seti)
      echo "Nerd Fonts - Seti-UI + Custom"
      draw_with_perl "__RANGE__" e5fa e6b7
      ;;
    --weather)
      echo "Nerd Fonts - Weather Icons"
      draw_with_perl "__RANGE__" e300 e3e3
      ;;
    --codi)
      echo "Nerd Fonts - Codicons"
      draw_with_perl "__RANGE__" ea60 ec1e
      ;;
    -*)
      opt="${OPT#-}"
      opt="${opt#-}"
      printf '%s: illegal option -- %s\n' "$PROGNAME" "$opt" >&2
      exit 1
      ;;
    *)
      usage
      ;;
  esac
  echo
done
