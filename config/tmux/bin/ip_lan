#!/usr/bin/env bash
#
# tmux LAN IPv4 script
#

set -Eeuo pipefail
trap 'echo "[ERROR] ${BASH_SOURCE[0]}:${LINENO} aborted." >&2' ERR INT

#######################################
# OS detection
#######################################

ostype() {
  printf '%s\n' "${OSTYPE,,}"
}

export SHELL_PLATFORM='unknown'

case "$(ostype)" in
  *linux*)  SHELL_PLATFORM='linux' ;;
  *darwin*) SHELL_PLATFORM='osx'   ;;
  *bsd*)    SHELL_PLATFORM='bsd'   ;;
esac

shell_is_linux() { [[ $SHELL_PLATFORM == linux ]]; }
shell_is_osx()   { [[ $SHELL_PLATFORM == osx   ]]; }
shell_is_bsd()   { [[ $SHELL_PLATFORM == bsd   ]]; }
shell_is_unix()  { [[ $SHELL_PLATFORM == linux || $SHELL_PLATFORM == bsd ]]; }

export -f shell_is_linux shell_is_osx shell_is_bsd shell_is_unix

#######################################
# LAN IP detection
#######################################
__run_lan() {
  local lan_ip=""
  local nic

  if shell_is_bsd || shell_is_osx; then
    # BSD / macOS (ifconfig)
    while read -r nic; do
      lan_ip=$(
        ifconfig "$nic" 2>/dev/null |
          awk '$1 == "inet" { print $2; exit }'
      )
      [[ -n "$lan_ip" ]] && break
    done < <(
      ifconfig 2>/dev/null |
        awk -F':' '/^[a-z]/ && $1 !~ /^lo/ { print $1 }'
    )

  else
    # Linux (iproute2)
    while read -r nic; do
      lan_ip=$(
        ip -4 addr show "$nic" 2>/dev/null |
          awk '/inet / { print $2 }' |
          cut -d/ -f1 |
          tail -n 1
      )
      [[ -n "$lan_ip" ]] && break
    done < <(
      ip -o link show |
        awk -F': ' '{print $2}' |
        grep -v '^lo$'
    )
  fi

  printf 'ï„‰ %s\n' "${lan_ip:-N/A}"
}

__run_lan
