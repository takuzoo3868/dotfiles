#!/usr/bin/env bash
#
# tmux LAN IPv4 script
#
# Author: takuzoo3868
# Last Modified: 9 Feb 2026.
#

set -Eeuo pipefail
trap 'echo "[ERROR] ${BASH_SOURCE[0]}:${LINENO} aborted." >&2' ERR INT

#######################################
# OS detection
#######################################

ostype() {
  printf '%s\n' "${OSTYPE}"
}

export SHELL_PLATFORM='unknown'

case "$(ostype)" in
  *linux*)  SHELL_PLATFORM='linux' ;;
  *darwin*) SHELL_PLATFORM='osx'   ;;
esac

shell_is_linux() { [[ $SHELL_PLATFORM == linux ]]; }
shell_is_osx()   { [[ $SHELL_PLATFORM == osx   ]]; }

export -f shell_is_linux shell_is_osx

#######################################
# LAN IP detection
#######################################
__run_lan() {
  local lan_ip=""
  local nic

  if shell_is_osx; then
    # macOS (ifconfig)
    while read -r nic; do
      if ifconfig "$nic" 2>/dev/null | grep -q "status: active"; then
        ip_candidate=$(ifconfig "$nic" 2>/dev/null | \
          awk '$1 == "inet" { print $2 }' | \
          grep -E '^(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[01])\.)')
        [[ -n "$ip_candidate" ]] && lan_ip="$ip_candidate" && break
      fi
    done < <(
      ifconfig 2>/dev/null |
        awk -F':' '/^[a-z]/ && $1 !~ /^lo/ { print $1 }'
    )

  else
    # Linux (iproute2)
    while read -r nic; do
      lan_ip=$(
        ip -4 addr show "$nic" 2>/dev/null |
          awk '/inet / { print $2 }' |
          cut -d/ -f1 |
          tail -n 1
      )
      [[ -n "$lan_ip" ]] && break
    done < <(
      ip -o link show |
        awk -F': ' '{print $2}' |
        grep -v '^lo$'
    )
  fi

  printf 'ó°Œ— %s\n' "${lan_ip:-N/A}"
}

__run_lan
