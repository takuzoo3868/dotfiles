#!/usr/bin/env bash
#
# tmux WAN IPv4 script
#
# Author: takuzoo3868
# Last Modified: 9 Feb 2026.
#

set -Eeuo pipefail
trap 'echo "[ERROR] ${BASH_SOURCE[0]}:${LINENO} aborted." >&2' ERR INT

#######################################
# Temporary directory
#######################################

export DIR_TEMPORARY="/tmp/tmux-wan_${USER}"
if [ ! -d "$DIR_TEMPORARY" ]; then
	mkdir -p "$DIR_TEMPORARY"
fi

#######################################
# WAN IP
#######################################

__run_wan() {
  local tmp_file="${DIR_TEMPORARY}/wan_ip.txt"
  local wan_ip=""
  local last_update=0
  local time_now
  local update_period=900  # seconds

  # stat compatibility
  if command -v stat >/dev/null 2>&1; then
    if stat -c "%Y" "$tmp_file" >/dev/null 2>&1; then
      stat_cmd='stat -c %Y'
    else
      stat_cmd='stat -f %m'
    fi
  fi

  # Read cache if valid
  if [[ -f "$tmp_file" ]]; then
    last_update=$($stat_cmd "$tmp_file")
    time_now=$(date +%s)

    if (( time_now - last_update < update_period )); then
      wan_ip=$(<"$tmp_file")
    fi
  fi

  # Fetch WAN IP
  if [[ -z "$wan_ip" ]]; then
    if wan_ip=$(curl --max-time 2 -fs http://whatismyip.akamai.com/); then
      printf '%s\n' "$wan_ip" >"$tmp_file"
    elif [[ -f "$tmp_file" ]]; then
      wan_ip=$(<"$tmp_file")
    fi
  fi

  if [[ -n "$wan_ip" ]]; then
    printf 'ó°–ˆ %s\n' "$wan_ip"
  fi
}

__run_wan