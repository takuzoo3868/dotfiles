#!/usr/bin/env bash
#
# tmux earthquake status script
# REST API: default
# WebSocket: --daemon
#
# Author: takuzoo3868
# Last Modified: 9 Feb 2026.
#

set -Eeuo pipefail
trap 'echo "[ERROR] ${BASH_SOURCE[0]}:${LINENO} aborted." >&2' ERR INT

#######################################
# Temporary directory
#######################################

export EARTHQUAKE_DIR_TEMPORARY="/tmp/tmux-earthquake_${USER}"
if [ ! -d "$EARTHQUAKE_DIR_TEMPORARY" ]; then
  mkdir -p "$EARTHQUAKE_DIR_TEMPORARY"
fi

readonly EARTHQUAKE_TMP_FILE="${EARTHQUAKE_DIR_TEMPORARY}/earthquake.txt"
readonly EARTHQUAKE_LOCK_FILE="${EARTHQUAKE_DIR_TEMPORARY}/earthquake_ws.lock"

#######################################
# Defaults
#######################################

readonly EARTHQUAKE_DATA_PROVIDER_DEFAULT="p2pquake"
readonly UPDATE_PERIOD_DEFAULT=25            # sec
readonly ALERT_TIME_WINDOW_DEFAULT=20        # min
readonly EARTHQUAKE_GET_DATA_LIMIT_DEFAULT=1
readonly EARTHQUAKE_MIN_SCALE_DEFAULT=10     # 10(震度1)、20(震度2)、30(震度3)、40(震度4)、45(震度5弱)、50(震度5強)、55(震度6弱)、60(震度6強)、70(震度7)

export EARTHQUAKE_DATA_PROVIDER="${EARTHQUAKE_DATA_PROVIDER:-$EARTHQUAKE_DATA_PROVIDER_DEFAULT}"
export UPDATE_PERIOD="${UPDATE_PERIOD:-$UPDATE_PERIOD_DEFAULT}"
export ALERT_TIME_WINDOW="${ALERT_TIME_WINDOW:-$ALERT_TIME_WINDOW_DEFAULT}"
export EARTHQUAKE_GET_DATA_LIMIT="${EARTHQUAKE_GET_DATA_LIMIT:-$EARTHQUAKE_GET_DATA_LIMIT_DEFAULT}"
export EARTHQUAKE_MIN_SCALE="${EARTHQUAKE_MIN_SCALE:-$EARTHQUAKE_MIN_SCALE_DEFAULT}"

#######################################
# Helpers
#######################################

__to_epoch() {
  date -d "$1" +%s 2>/dev/null || \
  date -j -f "%Y/%m/%d %H:%M:%S" "$1" +%s 2>/dev/null
}

__to_hhmm() {
  date -d "$1" +%H:%M 2>/dev/null || \
  date -j -f "%Y/%m/%d %H:%M:%S" "$1" +%H:%M 2>/dev/null
}

__read_tmp_file() {
  [[ -f "$EARTHQUAKE_TMP_FILE" ]] || return
  cat "$EARTHQUAKE_TMP_FILE" 2>/dev/null
  exit 0
}

__check_alert_time_window() {
  local timestamp="$1"
  local unixtime now

  unixtime=$(__to_epoch "$timestamp" || echo 0)
  now=$(date +%s)

  (( (now - unixtime) / 60 < ALERT_TIME_WINDOW ))
}

__get_earthquake_scale() {
  case "$1" in
    10) echo "1" ;;
    20) echo "2" ;;
    30) echo "3" ;;
    40) echo "4" ;;
    45) echo "5弱" ;;
    50) echo "5強" ;;
    55) echo "6弱" ;;
    60) echo "6強" ;;
    70) echo "7" ;;
    *)  echo "不明" ;;
  esac
}

__get_tsunami_info() {
  case "$1" in
    Warning)      echo "津波予報" ;;
    Watch)        echo "津波注意報" ;;
    NonEffective) echo "影響なし" ;;
    Checking)     echo "調査中" ;;
    Unknown)      echo "不明" ;;
    None)         echo "なし" ;;
    *)            echo "不明" ;;
  esac
}

#######################################
# p2pquake: REST API
#######################################

__p2pquake_rest_api() {
  command -v curl >/dev/null || return
  command -v jq   >/dev/null || return

  local last_update time_now

  if [[ -f "$EARTHQUAKE_TMP_FILE" ]]; then
    if stat -c %Y "$EARTHQUAKE_TMP_FILE" >/dev/null 2>&1; then
      last_update=$(stat -c %Y "$EARTHQUAKE_TMP_FILE") || last_update=0
    else
      last_update=$(stat -f '%m' "$EARTHQUAKE_TMP_FILE") || last_update=0
    fi

    time_now=$(date +%s)
    if (( time_now - last_update < UPDATE_PERIOD )); then
      __read_tmp_file
    fi
  fi

  # local data location magnitude scale tsunami timestamp timestamp_24
  local data location scale tsunami timestamp timestamp_24

  data=$(curl --max-time 4 -s \
    "https://api.p2pquake.net/v2/jma/quake?limit=${EARTHQUAKE_GET_DATA_LIMIT}&min_scale=${EARTHQUAKE_MIN_SCALE}") || true

  [[ -z "$data" || "$data" == "[]" ]] && __read_tmp_file && return

  location=$(jq -r '.[0].earthquake.hypocenter.name' <<<"$data")
  # magnitude=$(jq -r '.[].earthquake.hypocenter.magnitude' <<<"$data")
  scale=$(jq -r '.[0].earthquake.maxScale' <<<"$data")
  tsunami=$(jq -r '.[0].earthquake.domesticTsunami' <<<"$data")
  timestamp=$(jq -r '.[0].earthquake.time' <<<"$data")
  timestamp_24=$(__to_hhmm "$timestamp" || echo "--:--")

  if __check_alert_time_window "$timestamp"; then
    local scale_jp tsunami_jp
    scale_jp=$(__get_earthquake_scale "$scale")
    tsunami_jp=$(__get_tsunami_info "$tsunami")

    echo "  ${location} ${timestamp_24}  ${scale_jp}  ${tsunami_jp} " | tee "$EARTHQUAKE_TMP_FILE"
  else
    echo "  地震情報なし " | tee "$EARTHQUAKE_TMP_FILE"
  fi
}

#######################################
# p2pquake: WebSocket
#######################################

__p2pquake_ws_daemon() {
  command -v websocat >/dev/null || exit 1
  command -v jq >/dev/null || exit 1

  if command -v flock >/dev/null; then
    exec 9>"$EARTHQUAKE_LOCK_FILE" || exit 1
    flock -n 9 || exit 0
    trap 'pkill -P $$ 2>/dev/null; rm -f "$EARTHQUAKE_LOCK_FILE"; exit 0' HUP INT TERM EXIT
  else
    local lock_dir="${EARTHQUAKE_LOCK_FILE}.dir"
    if ! mkdir "$lock_dir" 2>/dev/null; then
      exit 0
    fi
    trap 'pkill -P $$ 2>/dev/null; rm -rf "$lock_dir"; exit 0' HUP INT TERM EXIT
  fi

  local tmux_pid="${2:-}"
  if [[ -n "$tmux_pid" ]]; then
    (
      while kill -0 "$tmux_pid" 2>/dev/null; do
        sleep 5
      done
      kill -HUP $$ 2>/dev/null
    ) &
  fi

  local last_line="  地震情報待機中 "
  while true; do
    while IFS= read -r line; do
      code=$(jq -r '.code' <<<"$line" 2>/dev/null)

      case "$code" in
        556) # 556(緊急地震速報（警報）)
          cancelled=$(jq -r '.cancelled' <<<"$line")
          [[ "$cancelled" == "true" ]] && continue

          IFS=$'\t' read -r location magnitude timestamp < <(
            jq -r '[
              .earthquake.hypocenter.name,
              .earthquake.hypocenter.magnitude,
              .earthquake.originTime
            ] | @tsv' <<<"$line"
          )

          timestamp_24=$(__to_hhmm "$timestamp" || echo "--:--")

          last_line="  EEW ${location} ${timestamp_24} M${magnitude}"
          ;;

        551) # 551(地震情報)
          IFS=$'\t' read -r scale location tsunami timestamp < <(
            jq -r 'if (.earthquake.maxScale < '"$EARTHQUAKE_MIN_SCALE"') then empty else [
              .earthquake.maxScale,
              .earthquake.hypocenter.name,
              .earthquake.domesticTsunami,
              .earthquake.time
            ] | @tsv end' <<<"$line"
          )

          scale_jp=$(__get_earthquake_scale "$scale")
          tsunami_jp=$(__get_tsunami_info "$tsunami")
          timestamp_24=$(__to_hhmm "$timestamp"|| echo "--:--")

          last_line="  ${location} ${timestamp_24}  ${scale_jp}  ${tsunami_jp} "
          ;;
      esac

      printf "%s" "$last_line" > "$EARTHQUAKE_TMP_FILE"
    done < <(
      websocat -t --no-close wss://api.p2pquake.net/v2/ws 2>/dev/null
    )

    sleep 3
  done
}

__p2pquake_tmux() {
  __read_tmp_file || printf "  地震情報待機中 "
}

#######################################
# Main
#######################################

__run_earthquake() {
  case "${1:-}" in
    --daemon)
      __p2pquake_ws_daemon "$@"
      ;;
    --tmux)
      __p2pquake_tmux
      ;;
    *)
      __p2pquake_rest_api
      ;;
  esac
}

__run_earthquake "$@"
