#!/usr/bin/env bash
#
# tmux earthquake status script
#
# Author: takuzoo3868
# Last Modified: 9 Feb 2026.
#

set -Eeuo pipefail
trap 'echo "[ERROR] ${BASH_SOURCE[0]}:${LINENO} aborted." >&2' ERR INT

#######################################
# OS detection
#######################################

ostype() {
  printf '%s\n' "${OSTYPE}"
}

export SHELL_PLATFORM='unknown'

case "$(ostype)" in
  *linux*)  SHELL_PLATFORM='linux' ;;
  *darwin*) SHELL_PLATFORM='osx'   ;;
  *bsd*)    SHELL_PLATFORM='bsd'   ;;
esac

shell_is_linux() { [[ $SHELL_PLATFORM == linux ]]; }
shell_is_osx()   { [[ $SHELL_PLATFORM == osx   ]]; }
shell_is_bsd()   { [[ $SHELL_PLATFORM == bsd   ]]; }
shell_is_unix()  { [[ $SHELL_PLATFORM == linux || $SHELL_PLATFORM == bsd ]]; }

export -f shell_is_linux shell_is_osx shell_is_bsd shell_is_unix

#######################################
# Temporary directory
#######################################

export EARTHQUAKE_DIR_TEMPORARY="/tmp/tmux-earthquake_${USER}"
if [ ! -d "$EARTHQUAKE_DIR_TEMPORARY" ]; then
  mkdir -p "$EARTHQUAKE_DIR_TEMPORARY"
fi

readonly EARTHQUAKE_TMP_FILE="${EARTHQUAKE_DIR_TEMPORARY}/earthquake.txt"

#######################################
# Defaults
#######################################

readonly EARTHQUAKE_DATA_PROVIDER_DEFAULT="p2pquake"
readonly UPDATE_PERIOD_DEFAULT=20            # sec
readonly ALERT_TIME_WINDOW_DEFAULT=30        # min
readonly EARTHQUAKE_GET_DATA_LIMIT_DEFAULT=1
readonly EARTHQUAKE_MIN_SCALE_DEFAULT=10     # 10(震度1)、20(震度2)、30(震度3)、40(震度4)、45(震度5弱)、50(震度5強)、55(震度6弱)、60(震度6強)、70(震度7)

export EARTHQUAKE_DATA_PROVIDER="${EARTHQUAKE_DATA_PROVIDER:-$EARTHQUAKE_DATA_PROVIDER_DEFAULT}"
export UPDATE_PERIOD="${UPDATE_PERIOD:-$UPDATE_PERIOD_DEFAULT}"
export ALERT_TIME_WINDOW="${ALERT_TIME_WINDOW:-$ALERT_TIME_WINDOW_DEFAULT}"
export EARTHQUAKE_GET_DATA_LIMIT="${EARTHQUAKE_GET_DATA_LIMIT:-$EARTHQUAKE_GET_DATA_LIMIT_DEFAULT}"
export EARTHQUAKE_MIN_SCALE="${EARTHQUAKE_MIN_SCALE:-$EARTHQUAKE_MIN_SCALE_DEFAULT}"

#######################################
# Helpers
#######################################

__read_tmp_file() {
  [[ -f "$EARTHQUAKE_TMP_FILE" ]] || return
  cat "$EARTHQUAKE_TMP_FILE"
  exit 0
}

__check_alert_time_window() {
  local timestamp="$1"
  local unixtime now

  if shell_is_osx || shell_is_bsd; then
    unixtime=$(date -j -f "%Y-%m-%dT%H:%M:%S%z" "$timestamp" +%s 2>/dev/null || echo 0)
  else
    unixtime=$(date -d "$timestamp" +%s 2>/dev/null || echo 0)
  fi

  now=$(date +%s)
  (( (now - unixtime) / 60 < ALERT_TIME_WINDOW ))
}

__get_earthquake_scale() {
  case "$1" in
    10) echo "1" ;;
    20) echo "2" ;;
    30) echo "3" ;;
    40) echo "4" ;;
    45) echo "5弱" ;;
    50) echo "5強" ;;
    55) echo "6弱" ;;
    60) echo "6強" ;;
    70) echo "7" ;;
    *)  echo "" ;;
  esac
}

__get_tsunami_info() {
  case "$1" in
    Warning)      echo "津波予報" ;;
    Watch)        echo "津波注意報" ;;
    NonEffective) echo "影響なし" ;;
    Checking)     echo "調査中" ;;
    Unknown)      echo "不明" ;;
    None)         echo "なし" ;;
    *)            echo "不明" ;;
  esac
}

#######################################
# Provider: p2pquake
#######################################

__p2pquake_earthquake() {
  command -v curl >/dev/null || return
  command -v jq   >/dev/null || return

  local last_update time_now

  if [[ -f "$EARTHQUAKE_TMP_FILE" ]]; then
    if shell_is_osx || shell_is_bsd; then
      last_update=$(stat -f "%m" "$EARTHQUAKE_TMP_FILE")
    else
      last_update=$(stat -c "%Y" "$EARTHQUAKE_TMP_FILE")
    fi

    time_now=$(date +%s)
    if (( time_now - last_update < UPDATE_PERIOD )); then
      __read_tmp_file
    fi
  fi

  # local data location magnitude scale tsunami timestamp timestamp_24
  local data location scale tsunami timestamp timestamp_24

  data=$(curl --max-time 4 -s \
    "https://api.p2pquake.net/v2/jma/quake?limit=${EARTHQUAKE_GET_DATA_LIMIT}&min_scale=${EARTHQUAKE_MIN_SCALE}" \
    || true)

  [[ -z "$data" ]] && __read_tmp_file && return

  location=$(jq -r '.[].earthquake.hypocenter.name' <<<"$data")
  # magnitude=$(jq -r '.[].earthquake.hypocenter.magnitude' <<<"$data")
  scale=$(jq -r '.[].earthquake.maxScale' <<<"$data")
  tsunami=$(jq -r '.[].earthquake.domesticTsunami' <<<"$data")
  timestamp=$(jq -r '.[].earthquake.time' <<<"$data")

  if shell_is_osx || shell_is_bsd; then
    timestamp_24=$(date -j -f "%Y-%m-%dT%H:%M:%S%z" "$timestamp" +%H:%M 2>/dev/null || echo "--:--")
  else
    timestamp_24=$(date -d "$timestamp" +%H:%M 2>/dev/null || echo "--:--")
  fi

  if __check_alert_time_window "$timestamp"; then
    local scale_jp tsunami_jp
    scale_jp=$(__get_earthquake_scale "$scale")
    tsunami_jp=$(__get_tsunami_info "$tsunami")

    echo "  ${location} ${timestamp_24}  ${scale_jp}  ${tsunami_jp} " | tee "$EARTHQUAKE_TMP_FILE"
  else
    echo "  地震情報なし " | tee "$EARTHQUAKE_TMP_FILE"
  fi
}

#######################################
# Main
#######################################

__run_earthquake() {
  case "$EARTHQUAKE_DATA_PROVIDER" in
    p2pquake) __p2pquake_earthquake ;;
    *) echo "Unknown provider: $EARTHQUAKE_DATA_PROVIDER" ;;
  esac
}

__run_earthquake
