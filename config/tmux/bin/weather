#!/usr/bin/env bash
#
# tmux weather status script
# API: https://openweathermap.org/current
# NEED: API KEY in .bashrc_local
#   export WEATHER_API="xxxxxxxxxxxxxxxxxx"
#
# Author: takuzoo3868
# Last Modified: 9 Feb 2026.
#

set -Eeuo pipefail
trap 'echo "[ERROR] ${BASH_SOURCE[0]}:${LINENO} aborted." >&2' ERR INT

#######################################
# Temporary directory
#######################################

export WEATHER_DIR_TEMPORARY="/tmp/tmux-weather_${USER}"
if [ ! -d "$WEATHER_DIR_TEMPORARY" ]; then
  mkdir -p "$WEATHER_DIR_TEMPORARY"
fi

readonly WEATHER_TMP_FILE="${WEATHER_DIR_TEMPORARY}/weather_openweathermap.txt"

#######################################
# Defaults
#######################################

readonly WEATHER_DATA_PROVIDER_DEFAULT="openweathermap"
readonly WEATHER_UNIT_DEFAULT="metric"        # metric / imperial / kelvin
readonly WEATHER_UPDATE_PERIOD_DEFAULT="300"  # sec

export WEATHER_DATA_PROVIDER="${WEATHER_DATA_PROVIDER:-$WEATHER_DATA_PROVIDER_DEFAULT}"
export WEATHER_UNIT="${WEATHER_UNIT:-$WEATHER_UNIT_DEFAULT}"
export WEATHER_UPDATE_PERIOD="${WEATHER_UPDATE_PERIOD:-$WEATHER_UPDATE_PERIOD_DEFAULT}"

case "$WEATHER_UNIT" in
  metric)   WEATHER_UNIT_CASE="C" ;;
  imperial) WEATHER_UNIT_CASE="F" ;;
  *)        WEATHER_UNIT_CASE="K" ;;
esac
export WEATHER_UNIT_CASE

#######################################
# Location detection
#######################################

__get_location() {
  local city
  city=$(curl -sf "http://ip-api.com/json/?fields=city" | jq -r '.city // empty') || true
  echo "${city:-Japan}"
}

WEATHER_LOCATION="$(__get_location)"
export WEATHER_LOCATION

#######################################
# Helpers
#######################################

__file_is_fresh() {
  local file="$1"
  [[ ! -f "$file" ]] && return 1

  local last now
  if stat -c %Y "$file" >/dev/null 2>&1; then
    last=$(stat -c %Y "$file") || return 1
  else
    last=$(stat -f '%m' "$file") || return 1
  fi
  now=$(date +%s)
  (( now - last < WEATHER_UPDATE_PERIOD ))
}

__read_tmp_file() {
  [[ -f "$WEATHER_TMP_FILE" ]] || return
  cat "$WEATHER_TMP_FILE"
  exit 0
}

#######################################
# Main
#######################################

__run_weather() {
  __file_is_fresh "$WEATHER_TMP_FILE" && __read_tmp_file

  local data
  data=$(curl --max-time 4 -s \
    "https://api.openweathermap.org/data/2.5/weather?q=${WEATHER_LOCATION}&units=${WEATHER_UNIT}&appid=${WEATHER_API}") || true

  [[ -z "$data" ]] && __read_tmp_file

  local degree weather_id sunrise sunset
  degree=$(jq -r '.main.temp // empty' <<<"$data")
  weather_id=$(jq -r '.weather[0].id // empty' <<<"$data")
  sunrise=$(jq -r '.sys.sunrise // 0' <<<"$data")
  sunset=$(jq -r '.sys.sunset // 0' <<<"$data")

  if [[ "$WEATHER_UNIT_CASE" == "K" ]]; then
    degree=$(awk "BEGIN{printf \"%.1f\", $degree + 273.15}")
  fi

  __epoch_to_hhmm() {
    if date -d "@0" +%H%M >/dev/null 2>&1; then
      date -d "@$1" +%H%M
    else
      date -r "$1" +%H%M
    fi
  }

  local sunrise_h sunset_h
  sunrise_h=$(__epoch_to_hhmm "$sunrise")
  sunset_h=$(__epoch_to_hhmm "$sunset")

  local icon
  icon=$(__get_weather_image "$weather_id" "$sunrise_h" "$sunset_h" "$degree")

  echo "${icon} ${degree}°$(echo "$WEATHER_UNIT_CASE" | tr '[:lower:]' '[:upper:]')" | tee "$WEATHER_TMP_FILE"
}

#######################################
# Weather icons
# Available conditions: https://openweathermap.org/weather-conditions
#######################################
__get_weather_image() {
  local weather_id="$1" sunrise="$2" sunset="$3" degree="$4"
  local now
  now=$(date +%H%M)

  case "$weather_id" in
    ## Group 2xx: Thunderstorm
    2??)
      echo "󰖓"
      ;;
    
    ## Group 3xx: Drizzle
    3??)
      echo ""  # (alternatve) sprinkle
      ;;
    
    ## Group 5xx: Rain
    5??)
      case "$weather_id" in
        511)
          echo "󰙿"  # freezing rain
          ;;
        520|521|522|531)
          echo ""  # shower rain
          ;;
        *)
          echo ""
          ;;
      esac
      ;;
    
    ## Group 6xx: Snow
    6??)
      case "$weather_id" in
        611|612|613)
          echo "󰖒"  # sleet
          ;;
        *)
          echo ""
          ;;
      esac
      ;;
    
    ## Group 7xx: Atmosphere
    7??)
      case "$weather_id" in
        711)
          echo ""  # smoke
          ;;
        731|751|761)
          echo ""  # dust
          ;;
        762)
          echo ""  # volcanic ash
          ;;
        771)
          echo "󰖖"  # squalls
          ;;
        781)
          echo "󰼸"  # tornado
          ;;
        *)
          echo "󰖑"
          ;;
      esac
      ;;
    
    ## Group 8xx: Clear, Clouds
    8??)
      case "$weather_id" in
        800)
          if (( now >= sunset || now <= sunrise )); then
            (( $(awk "BEGIN{print ($degree <= 0)}") )) && echo "󰼩" || echo ""
          else
            (( $(awk "BEGIN{print ($degree >= 28)}") )) && echo "󰸁" || echo ""
          fi
          ;;
        801)
          if (( now >= sunset || now <= sunrise )); then
            echo ""
          else
            echo ""
          fi
          ;;
        802)
          echo ""
          ;;
        *)
          echo ""
          ;;
      esac
      ;;
    
    *)
      echo ""
      ;;
  esac
}

# exec
__run_weather
