#!/usr/bin/env bash
#
# tmux weather status script
# API: https://openweathermap.org/current
# NEED API KEY in .bashrc_local: WEATHER_API
#

set -Eeuo pipefail
trap 'echo "[ERROR] ${BASH_SOURCE[0]}:${LINENO} aborted." >&2' ERR INT

#######################################
# OS detection
#######################################

ostype() {
  printf '%s\n' "${OSTYPE,,}"
}

export SHELL_PLATFORM='unknown'

case "$(ostype)" in
  *linux*)  SHELL_PLATFORM='linux' ;;
  *darwin*) SHELL_PLATFORM='osx'   ;;
  *bsd*)    SHELL_PLATFORM='bsd'   ;;
esac

shell_is_linux() { [[ $SHELL_PLATFORM == linux ]]; }
shell_is_osx()   { [[ $SHELL_PLATFORM == osx   ]]; }
shell_is_bsd()   { [[ $SHELL_PLATFORM == bsd   ]]; }
shell_is_unix()  { [[ $SHELL_PLATFORM == linux || $SHELL_PLATFORM == bsd ]]; }

export -f shell_is_linux shell_is_osx shell_is_bsd shell_is_unix

#######################################
# Temporary directory
#######################################

export WEATHER_DIR_TEMPORARY="/tmp/tmux-weather_${USER}"
if [ ! -d "$WEATHER_DIR_TEMPORARY" ]; then
  mkdir -p "$WEATHER_DIR_TEMPORARY"
fi

readonly WEATHER_TMP_FILE="${WEATHER_DIR_TEMPORARY}/weather_openweathermap.txt"

#######################################
# Defaults
#######################################

readonly WEATHER_DATA_PROVIDER_DEFAULT="openweathermap"
readonly WEATHER_UNIT_DEFAULT="metric"        # metric / imperial / kelvin
readonly WEATHER_UPDATE_PERIOD_DEFAULT="300"  # sec

export WEATHER_DATA_PROVIDER="${WEATHER_DATA_PROVIDER:-$WEATHER_DATA_PROVIDER_DEFAULT}"
export WEATHER_UNIT="${WEATHER_UNIT:-$WEATHER_UNIT_DEFAULT}"
export WEATHER_UPDATE_PERIOD="${WEATHER_UPDATE_PERIOD:-$WEATHER_UPDATE_PERIOD_DEFAULT}"

case "$WEATHER_UNIT" in
  metric)   WEATHER_UNIT_CASE="C" ;;
  imperial) WEATHER_UNIT_CASE="F" ;;
  *)        WEATHER_UNIT_CASE="K" ;;
esac
export WEATHER_UNIT_CASE

#######################################
# Location detection
#######################################

__get_location() {
  local city
  city=$(curl -sf "http://ip-api.com/json/?fields=city" | jq -r '.city // empty') || true
  echo "${city:-Japan}"
}
export WEATHER_LOCATION="$(__get_location)"

#######################################
# Helpers
#######################################

__file_is_fresh() {
  local file="$1"
  [[ ! -f "$file" ]] && return 1

  local last now
  if shell_is_bsd || shell_is_osx; then
    last=$(stat -f "%m" "$file")
  else
    last=$(stat -c "%Y" "$file")
  fi
  now=$(date +%s)
  (( now - last < WEATHER_UPDATE_PERIOD ))
}

__read_tmp_file() {
  [[ -f "$WEATHER_TMP_FILE" ]] || return
  cat "$WEATHER_TMP_FILE"
  exit 0
}

#######################################
# Main
#######################################

__run_weather() {
  __file_is_fresh "$WEATHER_TMP_FILE" && __read_tmp_file

  local data
  data=$(curl --max-time 4 -s \
    "https://api.openweathermap.org/data/2.5/weather?q=${WEATHER_LOCATION}&units=${WEATHER_UNIT}&appid=${WEATHER_API}") || true

  [[ -z "$data" ]] && __read_tmp_file  && return

  local degree condition sunrise sunset
  degree=$(jq -r '.main.temp // empty' <<<"$data")
  condition=$(jq -r '.weather[0].description // empty' <<<"$data")
  sunrise=$(jq -r '.sys.sunrise // 0' <<<"$data")
  sunset=$(jq -r '.sys.sunset // 0' <<<"$data")

  if [[ "$WEATHER_UNIT_CASE" == "K" ]]; then
    degree=$(awk "BEGIN{printf \"%.1f\", $degree + 273.15}")
  fi

  local sunrise_h sunset_h
  sunrise_h=$(date -d "@$sunrise" +%H%M 2>/dev/null || date -r "$sunrise" +%H%M)
  sunset_h=$(date -d "@$sunset" +%H%M 2>/dev/null || date -r "$sunset" +%H%M)

  local icon
  icon=$(__get_weather_image "$condition" "$sunrise_h" "$sunset_h" "$degree")

  echo "${icon} ${degree}°$(echo "$WEATHER_UNIT_CASE" | tr '[:lower:]' '[:upper:]')" | tee "$WEATHER_TMP_FILE"
}

#######################################
# Weather icons
# Available conditions: https://openweathermap.org/weather-conditions
#######################################
__get_weather_image() {
  local condition="$1" sunrise="$2" sunset="$3" degree="$4"
  local now
  now=$(date +%H%M)

  case "$condition" in
    ## Group 800: Clear
    "clear sky")
      if (( now >= sunset || now <= sunrise )); then
        (( $(awk "BEGIN{print ($degree <= 5)}") )) && echo "" || echo ""
      else
        (( $(awk "BEGIN{print ($degree >= 25)}") )) && echo "" || echo ""
      fi
      ;;
    ## Group 80x: Clouds
    "few clouds")
      echo "" ;;
    "scattered clouds")
      echo "" ;;
    "broken clouds" | "overcast clouds")
      echo "" ;;

    ## Group 7xx: Atmosphere
    "dust" | "Haze" | "Smoke" | "sand" | "dust whirls")
      echo "" ;;
    "fog" | "mist")
      echo "" ;;
    "volcanic ash")
      echo "" ;;
    "tornado" | "tropical storm" | "hurricane")
      echo "" ;;

    ## Group 5xx: Rain & Group 3xx: Drizzle
    "rain" | "light rain"  | "moderate rain" | "heavy intensity rain" | "drizzle" | "light intensity drizzle" | "heavy intensity drizzle" | "light intensity drizzle rain" | "drizzle rain")
      echo "" ;;
    "shower rain" | "scattered showers" | "very heavy rain" | "extreme rain" | "light intensity shower rain" | "heavy intensity shower rain" | "ragged shower rain" | "heavy intensity drizzle rain" | "shower rain and drizzle" | "heavy shower rain and drizzle" | "shower drizzle" | "squalls")
      echo "" ;;
    "mixed rain and snow" | "mixed rain and sleet" | "freezing drizzle" | "freezing rain" | "mixed rain and hail" | "Light rain and snow" | "rain and snow")
      echo "" ;;
    
    ## Group 6xx: Snow
    "snow" | "light snow" | "heavy snow" | "sleet" | "light shower sleet" | "shower sleet" | "light shower snow" | "shower snow" | "heavy shower snow")
      echo "" ;;
    
    ## Group 2xx: Thunderstorm
    "thunderstorm with light rain" | "thunderstorm with rain" | "thunderstorm with heavy rain" | "light thunderstorm" | "thunderstorm" | "heavy thunderstorm" | "ragged thunderstorm" | "thunderstorm with light drizzle" | "thunderstorm with drizzle" | "thunderstorm with heavy drizzle")
      echo "" ;;
    
    "not available")
      echo "" ;;
    *)
      echo "" ;;
  esac
}

# exec
__run_weather
